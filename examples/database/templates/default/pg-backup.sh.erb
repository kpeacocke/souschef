#!/bin/bash
# PostgreSQL backup script
# Generated by Chef

BACKUP_DIR="<%= @backup_dir %>"
RETENTION_DAYS=<%= @retention_days %>
DATE=$(date +%Y%m%d_%H%M%S)

# Create backup directory if it doesn't exist
mkdir -p "$BACKUP_DIR"

# Backup all databases
echo "Starting PostgreSQL backup at $(date)"

# Get list of databases
DATABASES=$(sudo -u postgres psql -lqt | cut -d \| -f 1 | grep -v '^$' | grep -v template | grep -v postgres)

for DB in $DATABASES; do
    echo "Backing up database: $DB"
    sudo -u postgres pg_dump "$DB" | gzip > "$BACKUP_DIR/${DB}_${DATE}.sql.gz"
done

# Remove old backups
echo "Removing backups older than $RETENTION_DAYS days"
find "$BACKUP_DIR" -name "*.sql.gz" -mtime +"$RETENTION_DAYS" -delete

echo "Backup completed at $(date)"
