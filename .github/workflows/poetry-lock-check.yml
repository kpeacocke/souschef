---
name: Poetry Lock Check

# Validates that poetry.lock is in sync with pyproject.toml
# Runs on all branches to catch issues early

on:
  pull_request:
    paths:
      - 'pyproject.toml'
      - 'poetry.lock'
  push:
    branches:
      - main
      - develop
      - 'feature/**'
      - 'bugfix/**'
      - 'release/**'
      - 'hotfix/**'
    paths:
      - 'pyproject.toml'
      - 'poetry.lock'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: "3.14"

jobs:
  check-lock:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: write
      pull-requests: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v6

    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v6
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install Poetry
      uses: snok/install-poetry@76e04a911780d5b312d89783f7b1cd627778900a  # v1.4.1
      with:
        version: latest
        virtualenvs-create: true
        virtualenvs-in-project: true

    - name: Regenerate poetry.lock if needed
      run: |
        # Check if lock is out of sync
        if ! poetry check --lock; then
          echo "ðŸ”„ Regenerating poetry.lock..."
          poetry lock
          echo "âœ… poetry.lock regenerated"
        else
          echo "âœ… poetry.lock is already in sync"
        fi

    - name: Check for changes and commit
      run: |
        if git diff --quiet poetry.lock; then
          echo "No changes to poetry.lock"
        else
          echo "Committing updated poetry.lock"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add poetry.lock
          git commit -m "chore: update poetry.lock"
          git push
        fi
