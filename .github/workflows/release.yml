name: Release

# Only trigger on release published (created by Release Please)
# Don't trigger on tag push to avoid duplicate runs
on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag to publish (e.g., v2.0.0)'
        required: true
        type: string

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false  # Don't cancel releases

env:
  PYTHON_VERSION: "3.14"

jobs:
  # Skip tests - they already passed in CI before merge to main
  # This workflow focuses on building and publishing the release
  validate:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: read
    outputs:
      tag: ${{ steps.get-tag.outputs.tag }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v6
      with:
        fetch-depth: 0
        ref: ${{ github.event_name == 'workflow_dispatch' && inputs.tag || github.ref }}

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Determine release tag
      id: get-tag
      env:
        INPUT_TAG: ${{ inputs.tag }}
        RELEASE_TAG: ${{ github.event.release.tag_name }}
        EVENT_NAME: ${{ github.event_name }}
      run: |
        if [ "$EVENT_NAME" = "workflow_dispatch" ]; then
          TAG="$INPUT_TAG"
        else
          TAG="$RELEASE_TAG"
        fi
        echo "tag=$TAG" >> $GITHUB_OUTPUT
        echo "Using tag: $TAG"

    - name: Validate release is on main branch
      env:
        TAG: ${{ steps.get-tag.outputs.tag }}
      run: |
        if ! git branch -r --contains "$TAG" 2>/dev/null | grep -q 'origin/main'; then
          echo "Error: Release tag must be on main branch"
          git branch -r --contains "$TAG" 2>/dev/null || echo "Tag not found"
          exit 1
        fi
        echo "✓ Release tag is on main branch"

    - name: Validate semver tag
      env:
        TAG: ${{ steps.get-tag.outputs.tag }}
      run: |
        if ! echo "$TAG" | grep -qE '^v[0-9]+\.[0-9]+\.[0-9]+$'; then
          echo "Error: Tag '$TAG' does not follow semver format (vX.Y.Z)"
          exit 1
        fi
        echo "✓ Tag '$TAG' is valid semver"

    - name: Verify tag version matches pyproject.toml
      env:
        TAG: ${{ steps.get-tag.outputs.tag }}
      run: |
        TAG_VERSION="${TAG#v}"
        # Use Python to parse TOML since it's more reliable than sed
        PYPROJECT_VERSION=$(python3 -c "import tomllib; print(tomllib.load(open('pyproject.toml', 'rb'))['tool']['poetry']['version'])")
        if [ "$TAG_VERSION" != "$PYPROJECT_VERSION" ]; then
          echo "Error: Tag version ($TAG_VERSION) != pyproject.toml version ($PYPROJECT_VERSION)"
          exit 1
        fi
        echo "✓ Version $TAG_VERSION matches pyproject.toml"

  build:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: validate
    permissions:
      contents: read

    steps:
    - name: Checkout repository
      uses: actions/checkout@v6
      with:
        ref: ${{ needs.validate.outputs.tag }}

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install Poetry
      uses: snok/install-poetry@76e04a911780d5b312d89783f7b1cd627778900a  # v1.4.1
      with:
        version: latest
        virtualenvs-create: true
        virtualenvs-in-project: true

    - name: Cache Poetry dependencies
      uses: actions/cache@v5
      with:
        path: .venv
        key: ${{ runner.os }}-poetry-${{ hashFiles('**/poetry.lock') }}
        restore-keys: |
          ${{ runner.os }}-poetry-

    - name: Install dependencies
      run: poetry install --no-interaction

    - name: Build Python package
      run: poetry build

    - name: Validate package with twine
      run: poetry run twine check dist/*

    - name: Upload package artifacts
      uses: actions/upload-artifact@v6
      with:
        name: release-packages
        path: dist/
        retention-days: 7

  publish-pypi:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: build
    permissions:
      contents: read

    steps:
    - name: Download package artifacts
      uses: actions/download-artifact@v7
      with:
        name: release-packages
        path: dist/

    - name: Publish package to PyPI
      uses: pypa/gh-action-pypi-publish@ed0c53931b1dc9bd32cbe73a98c7f6766f8a527e  # v1.13.0
      with:
        password: ${{ secrets.PYPI_API_TOKEN }}
        attestations: false

  attach-to-release:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [validate, build]
    permissions:
      contents: write

    steps:
    - name: Download package artifacts
      uses: actions/download-artifact@v7
      with:
        name: release-packages
        path: dist/

    - name: Upload packages to GitHub Release
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        TAG: ${{ needs.validate.outputs.tag }}
        REPO: ${{ github.repository }}
      run: |
        echo "Attaching packages to release $TAG..."
        gh release upload "$TAG" dist/* --repo "$REPO"
