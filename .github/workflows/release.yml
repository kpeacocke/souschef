name: Release

# Trigger after Main Branch Validation succeeds to avoid releasing before checks finish
on:
  workflow_run:
    workflows: ["Main Branch Validation"]
    types: [completed]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false  # Don't cancel releases

env:
  PYTHON_VERSION: "3.14"

jobs:
  # Skip tests - they already passed in CI before merge to main and in Main Branch Validation
  # This workflow focuses on building and publishing the release
  validate:
    if: (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: write  # Need write to create tags
      actions: read    # Needed to verify CodeQL run status
    outputs:
      tag: ${{ steps.get-tag.outputs.tag }}
      version: ${{ steps.get-tag.outputs.version }}
      should_release: ${{ steps.check-version.outputs.should_release }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v6
      with:
        fetch-depth: 0

    - name: Ensure CodeQL scan succeeded for this commit
      if: github.event_name == 'workflow_run'
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        REPO: ${{ github.repository }}
        HEAD_SHA: ${{ github.event.workflow_run.head_sha }}
      run: |
        echo "Checking CodeQL status for $HEAD_SHA"
        api_url="https://api.github.com/repos/${REPO}/actions/workflows/codeql.yml/runs?head_sha=${HEAD_SHA}"
        run_json=$(curl -s -H "Authorization: Bearer ${GH_TOKEN}" -H "Accept: application/vnd.github+json" "$api_url")
        conclusion=$(echo "$run_json" | jq -r '.workflow_runs[0].conclusion // "none"')
        if [ "$conclusion" != "success" ]; then
          echo "CodeQL workflow not successful for $HEAD_SHA (conclusion=$conclusion)"
          exit 1
        fi
        echo "CodeQL succeeded for $HEAD_SHA"

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Determine version from pyproject.toml
      id: get-tag
      run: |
        VERSION=$(python3 -c "import tomllib; print(tomllib.load(open('pyproject.toml', 'rb'))['tool']['poetry']['version'])")
        TAG="v${VERSION}"
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "tag=$TAG" >> $GITHUB_OUTPUT
        echo "Version from pyproject.toml: $VERSION"
        echo "Release tag: $TAG"

    - name: Check if tag already exists
      id: check-version
      env:
        TAG: ${{ steps.get-tag.outputs.tag }}
      run: |
        if git rev-parse "$TAG" >/dev/null 2>&1; then
          echo "Tag $TAG already exists - skipping release"
          echo "should_release=false" >> $GITHUB_OUTPUT
        else
          echo "Tag $TAG does not exist - will create release"
          echo "should_release=true" >> $GITHUB_OUTPUT
        fi

  build:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: validate
    if: needs.validate.outputs.should_release == 'true'
    permissions:
      contents: read

    steps:
    - name: Checkout repository
      uses: actions/checkout@v6
      with:
        ref: ${{ needs.validate.outputs.tag }}

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install Poetry
      uses: snok/install-poetry@76e04a911780d5b312d89783f7b1cd627778900a  # v1.4.1
      with:
        version: latest
        virtualenvs-create: true
        virtualenvs-in-project: true

    - name: Cache Poetry dependencies
      uses: actions/cache@v5
      with:
        path: .venv
        key: ${{ runner.os }}-poetry-${{ hashFiles('**/poetry.lock') }}
        restore-keys: |
          ${{ runner.os }}-poetry-

    - name: Install dependencies
      run: poetry install --no-interaction

    - name: Build Python package
      run: poetry build

    - name: Validate package with twine
      run: poetry run twine check dist/*

    - name: Upload package artifacts
      uses: actions/upload-artifact@v6
      with:
        name: release-packages
        path: dist/
        retention-days: 7

  publish-pypi:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [validate, build]
    if: needs.validate.outputs.should_release == 'true'
    permissions:
      contents: read
      id-token: write  # For trusted publishing

    steps:
    - name: Download package artifacts
      uses: actions/download-artifact@v7
      with:
        name: release-packages
        path: dist/

    - name: Publish package to PyPI
      uses: pypa/gh-action-pypi-publish@ed0c53931b1dc9bd32cbe73a98c7f6766f8a527e  # v1.13.0
      with:
        password: ${{ secrets.PYPI_API_TOKEN }}
        attestations: false

  create-release:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [validate, build]
    if: needs.validate.outputs.should_release == 'true'
    permissions:
      contents: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v6

    - name: Create git tag and GitHub release
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        TAG: ${{ needs.validate.outputs.tag }}
        VERSION: ${{ needs.validate.outputs.version }}
      run: |
        # Create and push tag
        git tag "$TAG"
        git push origin "$TAG"
        
        # Create GitHub release with auto-generated notes
        gh release create "$TAG" \
          --title "Release $VERSION" \
          --generate-notes \
          --latest

    - name: Download package artifacts
      uses: actions/download-artifact@v7
      with:
        name: release-packages
        path: dist/

    - name: Upload packages to GitHub Release
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        TAG: ${{ needs.validate.outputs.tag }}
      run: |
        echo "Attaching packages to release $TAG..."
        gh release upload "$TAG" dist/*
