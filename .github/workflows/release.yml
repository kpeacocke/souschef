name: Release

# Trigger after CI succeeds to avoid releasing before checks finish
on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false  # Don't cancel releases

env:
  PYTHON_VERSION: "3.12"

jobs:
  # Skip tests - they already passed in CI before merge to main and in Main Branch Validation
  # This workflow focuses on building and publishing the release
  validate:
    if: ((github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main')
         || (github.event_name == 'workflow_dispatch' && github.ref == 'refs/heads/main'))
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: write  # Need write to create tags
      actions: read    # Needed to verify CodeQL run status
    outputs:
      tag: ${{ steps.get-tag.outputs.tag }}
      version: ${{ steps.get-tag.outputs.version }}
      should_release: ${{ steps.decision.outputs.should_release }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v6
      with:
        fetch-depth: 0
        fetch-tags: true

    - name: Verify code is from main branch
      env:
        BRANCH: ${{ github.event.workflow_run.head_branch }}
      run: |
        if [[ -z "$BRANCH" ]] || [[ "$BRANCH" != "main" ]]; then
          printf 'ERROR: Release workflow can only run on main branch, got: %s\n' "$BRANCH" >&2
          exit 1
        fi
        echo "Verified: code is from main branch"

    - name: Ensure CodeQL scan succeeded for this commit (best-effort)
      if: github.event_name == 'workflow_run'
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        REPO: ${{ github.repository }}
        HEAD_SHA: ${{ github.event.workflow_run.head_sha }}
      run: |
        echo "Checking CodeQL status for $HEAD_SHA"
        api_url="https://api.github.com/repos/${REPO}/actions/workflows/codeql.yml/runs?head_sha=${HEAD_SHA}"
        run_json=$(curl -s -H "Authorization: Bearer ${GH_TOKEN}" -H "Accept: application/vnd.github+json" "$api_url") || true
        conclusion=$(echo "$run_json" | jq -r '.workflow_runs[0].conclusion // "none"')
        if [ "$conclusion" != "success" ]; then
          echo "Warning: CodeQL workflow not successful for $HEAD_SHA (conclusion=$conclusion). Proceeding because Main Branch Validation succeeded."
        else
          echo "CodeQL succeeded for $HEAD_SHA"
        fi

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Determine version from pyproject.toml
      id: get-tag
      run: |
        VERSION=$(python3 -c "import tomllib; print(tomllib.load(open('pyproject.toml', 'rb'))['tool']['poetry']['version'])")
        TAG="v${VERSION}"
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "tag=$TAG" >> $GITHUB_OUTPUT
        echo "Version from pyproject.toml: $VERSION"
        echo "Release tag: $TAG"

    - name: Check remote for existing tag
      id: check-tag
      env:
        TAG: ${{ steps.get-tag.outputs.tag }}
      run: |
        if git ls-remote --tags origin "$TAG" | grep -q "refs/tags/${TAG}$"; then
          echo "exists=true" >> $GITHUB_OUTPUT
          echo "Tag $TAG already exists on remote"
        else
          echo "exists=false" >> $GITHUB_OUTPUT
          echo "Tag $TAG does not exist on remote"
        fi

    - name: Check PyPI for existing version
      id: check-pypi
      env:
        VERSION: ${{ steps.get-tag.outputs.version }}
      run: |
        set -e
        exists=$(curl -fsSL https://pypi.org/pypi/souschef/json | jq -r --arg v "$VERSION" '.releases[$v] | if . == null then "false" else "true" end') || exists=false
        echo "exists=$exists" >> $GITHUB_OUTPUT
        if [ "$exists" = "true" ]; then
          echo "Version $VERSION already exists on PyPI"
        else
          echo "Version $VERSION not found on PyPI"
        fi

    - name: Decide whether to release
      id: decision
      env:
        TAG_EXISTS: ${{ steps.check-tag.outputs.exists }}
        PYPI_EXISTS: ${{ steps.check-pypi.outputs.exists }}
      run: |
        if [ "$TAG_EXISTS" = "true" ] || [ "$PYPI_EXISTS" = "true" ]; then
          echo "should_release=false" >> $GITHUB_OUTPUT
          echo "Skipping release: tag or PyPI version already exists."
        else
          echo "should_release=true" >> $GITHUB_OUTPUT
          echo "Proceeding with release."
        fi

  build:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: validate
    if: needs.validate.outputs.should_release == 'true'
    permissions:
      contents: read

    steps:
    - name: Checkout repository
      uses: actions/checkout@v6
      with:
        # Checkout the exact commit that triggered the workflow. The tag does
        # not exist yet (created later in create-release), so using the tag
        # here causes checkout failures.
        ref: ${{ github.sha }}
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install Poetry
      uses: snok/install-poetry@76e04a911780d5b312d89783f7b1cd627778900a  # v1.4.1
      with:
        version: latest
        virtualenvs-create: true
        virtualenvs-in-project: true

    - name: Cache Poetry dependencies
      uses: actions/cache@v5
      with:
        path: .venv
        key: ${{ runner.os }}-poetry-${{ hashFiles('**/poetry.lock') }}
        restore-keys: |
          ${{ runner.os }}-poetry-

    - name: Install dependencies
      run: poetry install --no-interaction

    - name: Install Twine (for package validation)
      run: poetry run python -m pip install --upgrade pip twine

    - name: Build Python package
      run: poetry build

    - name: Validate package with twine
      run: poetry run twine check dist/*

    - name: Upload package artifacts
      uses: actions/upload-artifact@v6
      with:
        name: release-packages
        path: dist/
        retention-days: 7

  publish-pypi:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [validate, build, create-release]
    if: needs.validate.outputs.should_release == 'true'
    permissions:
      contents: read
      id-token: write  # For trusted publishing
      deployments: write  # For deployment status updates

    steps:
    - name: Verify PyPI token configured
      env:
        PYPI_API_TOKEN: ${{ secrets.PYPI_API_TOKEN }}
      run: |
        if [ -z "$PYPI_API_TOKEN" ]; then
          echo "PYPI_API_TOKEN secret is not configured; aborting publish."
          exit 1
        fi

    - name: Start deployment
      uses: bobheadxi/deployments@648679e8e4915b27893bd7dbc35cb504dc915bc8  # v1.5.0
      id: deployment
      with:
        step: start
        token: ${{ secrets.GITHUB_TOKEN }}
        env: pypi
        ref: ${{ needs.validate.outputs.tag }}

    - name: Download package artifacts
      uses: actions/download-artifact@v7
      with:
        name: release-packages
        path: dist/

    - name: Publish package to PyPI
      uses: pypa/gh-action-pypi-publish@ed0c53931b1dc9bd32cbe73a98c7f6766f8a527e  # v1.13.0
      with:
        password: ${{ secrets.PYPI_API_TOKEN }}
        attestations: false

    - name: Update deployment status (success)
      uses: bobheadxi/deployments@648679e8e4915b27893bd7dbc35cb504dc915bc8  # v1.5.0
      if: success()
      with:
        step: finish
        token: ${{ secrets.GITHUB_TOKEN }}
        status: ${{ job.status }}
        deployment_id: ${{ steps.deployment.outputs.deployment_id }}
        env: pypi
        env_url: https://pypi.org/project/souschef/${{ needs.validate.outputs.version }}/

    - name: Update deployment status (failure)
      uses: bobheadxi/deployments@648679e8e4915b27893bd7dbc35cb504dc915bc8  # v1.5.0
      if: failure()
      with:
        step: finish
        token: ${{ secrets.GITHUB_TOKEN }}
        status: ${{ job.status }}
        deployment_id: ${{ steps.deployment.outputs.deployment_id }}
        env: pypi

  create-release:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [validate, build]
    if: needs.validate.outputs.should_release == 'true'
    permissions:
      contents: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v6
      with:
        ref: main
        fetch-depth: 0
        fetch-tags: true

    - name: Create git tag and GitHub release
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        TAG: ${{ needs.validate.outputs.tag }}
        VERSION: ${{ needs.validate.outputs.version }}
      run: |
        # Create and push tag (tag main HEAD explicitly)
        git tag "$TAG"
        git push origin "$TAG"

        # Create GitHub release with auto-generated notes
        gh release create "$TAG" \
          --title "Release $VERSION" \
          --generate-notes \
          --latest

    - name: Download package artifacts
      uses: actions/download-artifact@v7
      with:
        name: release-packages
        path: dist/

    - name: Upload packages to GitHub Release
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        TAG: ${{ needs.validate.outputs.tag }}
      run: |
        echo "Attaching packages to release $TAG..."
        gh release upload "$TAG" dist/*

  build-and-push-docker:
    runs-on: ubuntu-latest
    needs: [validate, publish-pypi, create-release]
    if: needs.validate.outputs.should_release == 'true'
    timeout-minutes: 30
    permissions:
      contents: read
      packages: write
      id-token: write
      deployments: write  # For deployment status updates
    outputs:
      image-digest: ${{ steps.build.outputs.digest }}
      tags: ${{ steps.meta.outputs.tags }}
      labels: ${{ steps.meta.outputs.labels }}
      image-pushed: ${{ steps.build.outputs.digest != '' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Start Docker deployment
        uses: bobheadxi/deployments@648679e8e4915b27893bd7dbc35cb504dc915bc8  # v1.5.0
        id: docker-deployment
        with:
          step: start
          token: ${{ secrets.GITHUB_TOKEN }}
          env: docker
          ref: ${{ needs.validate.outputs.tag }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          platforms: linux/amd64,linux/arm64

      - name: Generate build metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ghcr.io/${{ github.repository_owner }}/mcp-souschef
          tags: |
            type=semver,pattern={{version}},value=${{ needs.validate.outputs.version }}
            type=semver,pattern={{major}}.{{minor}},value=${{ needs.validate.outputs.version }}
            type=semver,pattern={{major}},value=${{ needs.validate.outputs.version }}
            type=raw,value=latest

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            PYTHON_VERSION=3.13.11
            POETRY_VERSION=1.8.3
          provenance: true
          sbom: true

      - name: Verify image digest
        run: |
          DIGEST="${{ steps.build.outputs.digest }}"
          if [ -z "$DIGEST" ]; then
            echo "ERROR: Image digest is empty"
            exit 1
          fi
          echo "Image pushed successfully with digest: $DIGEST"

      - name: Update Docker deployment status (success)
        uses: bobheadxi/deployments@648679e8e4915b27893bd7dbc35cb504dc915bc8  # v1.5.0
        if: success()
        with:
          step: finish
          token: ${{ secrets.GITHUB_TOKEN }}
          status: success
          deployment_id: ${{ steps.docker-deployment.outputs.deployment_id }}
          env: docker
          env_url: ghcr.io/${{ github.repository_owner }}/mcp-souschef:${{ needs.validate.outputs.version }}

      - name: Update Docker deployment status (failure)
        uses: bobheadxi/deployments@648679e8e4915b27893bd7dbc35cb504dc915bc8  # v1.5.0
        if: failure()
        with:
          step: finish
          token: ${{ secrets.GITHUB_TOKEN }}
          status: failure
          deployment_id: ${{ steps.docker-deployment.outputs.deployment_id }}
          env: docker

  scan-docker-image:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [validate, build-and-push-docker]
    if: needs.build-and-push-docker.result == 'success' && needs.build-and-push-docker.outputs.image-pushed == 'true'
    permissions:
      packages: read
      security-events: write

    steps:
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Run Trivy vulnerability scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ghcr.io/${{ github.repository_owner }}/mcp-souschef:${{ needs.validate.outputs.version }}
          format: sarif
          output: trivy-results.sarif
          severity: CRITICAL,HIGH
          exit-code: '0'

      - name: Upload Trivy results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: trivy-results.sarif
          category: trivy-image-scan

      - name: Display vulnerability report
        if: always()
        run: |
          echo "Vulnerability scan results:"
          echo "See GitHub Security tab for detailed report"

  test-docker-image:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [validate, build-and-push-docker]
    if: needs.build-and-push-docker.result == 'success' && needs.build-and-push-docker.outputs.image-pushed == 'true'
    permissions:
      packages: read

    steps:
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Run container and verify it starts
        run: |
          set -e
          # Pull the image first to ensure it's available
          docker pull "ghcr.io/${{ github.repository_owner }}/mcp-souschef:${{ needs.validate.outputs.version }}"

          # Test if container can start (with 10-second timeout)
          timeout 10 docker run --rm \
            -e STREAMLIT_SERVER_HEADLESS=true \
            -e STREAMLIT_BROWSER_GATHER_USAGE_STATS=false \
            "ghcr.io/${{ github.repository_owner }}/mcp-souschef:${{ needs.validate.outputs.version }}" \
            /bin/true || true

          echo "Container started successfully"

      - name: Verify health check works
        run: |
          set -e
          # Override the ENTRYPOINT to avoid streamlit run being prepended
          OUTPUT=$(docker run --rm --entrypoint="" \
            "ghcr.io/${{ github.repository_owner }}/mcp-souschef:${{ needs.validate.outputs.version }}" \
            python -m souschef.ui.health_check)

          echo "Health check output: $OUTPUT"

          if echo "$OUTPUT" | grep -q "healthy"; then
            echo "Health check passed"
          else
            echo "Health check failed"
            exit 1
          fi

  notify-docker-deployment:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [validate, build-and-push-docker, scan-docker-image, test-docker-image]
    if: |
      needs.validate.result == 'success'
      && needs.build-and-push-docker.result == 'success'
      && needs.scan-docker-image.result == 'success'
      && needs.test-docker-image.result == 'success'
    permissions:
      contents: read
      issues: write

    steps:
      - name: Create deployment notification issue
        uses: actions/github-script@v7
        with:
          script: |
            const version = "${{ needs.validate.outputs.version }}";
            const registry = "ghcr.io";
            const imageName = "mcp-souschef";
            const owner = "${{ github.repository_owner }}";
            const digest = "${{ needs.build-and-push-docker.outputs.image-digest }}";
            const tag = "${{ needs.validate.outputs.tag }}";

            const versionParts = version.split('.');
            const majorMinor = versionParts.length >= 2
              ? versionParts[0] + "." + versionParts[1]
              : versionParts[0];
            const major = versionParts[0];

            let body = "## Docker Image Published\n\n";
            body += "**Image:** `" + registry + "/" + owner + "/" + imageName + ":" + version + "`\n\n";
            body += "**Digest:** " + digest + "\n\n";
            body += "**Available Tags:**\n";
            body += "- `" + version + "` (exact version)\n";
            body += "- `" + majorMinor + "` (minor version)\n";
            body += "- `" + major + "` (major version)\n";
            body += "- `latest` (most recent release)\n\n";
            body += "**Container Registry:** [GitHub Container Registry](https://github.com/${{ github.repository }}/pkgs/container/" + imageName + ")\n\n";
            body += "**Pull Commands:**\n";
            body += "```bash\n";
            body += "# Pull specific version\n";
            body += "docker pull " + registry + "/" + owner + "/" + imageName + ":" + version + "\n\n";
            body += "# Pull latest\n";
            body += "docker pull " + registry + "/" + owner + "/" + imageName + ":latest\n\n";
            body += "# Pull major version\n";
            body += "docker pull " + registry + "/" + owner + "/" + imageName + ":" + major + "\n";
            body += "```\n\n";
            body += "**Security:** Vulnerability scan results available in [GitHub Security](https://github.com/${{ github.repository }}/security/dependabot)\n\n";
            body += "**Related Release:** " + tag + "\n\n";
            body += "## Build Information\n";
            body += "- **Release Pipeline:** ${{ github.workflow }} #${{ github.run_number }}\n";
            body += "- **Release Workflow Run:** ${{ github.run_id }}\n";
            body += "- **Release Commit:** ${{ github.sha }}";

            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: "Docker Image Published: " + tag,
              body: body,
              labels: ['deployment', 'docker', 'release']
            });

  release-complete:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [validate, build, publish-pypi, create-release, build-and-push-docker, scan-docker-image, test-docker-image, notify-docker-deployment]
    if: always()
    permissions:
      contents: read

    steps:
      - name: Release Pipeline Summary
        run: |
          cat > /tmp/summary.md << 'EOF'
          # Release Pipeline Complete

          ## Pipeline Status
          - **Validation:** ${{ needs.validate.result }}
          - **Build:** ${{ needs.build.result }}
          - **PyPI Publish:** ${{ needs.publish-pypi.result }}
          - **Create Release:** ${{ needs.create-release.result }}
          - **Docker Build & Push:** ${{ needs.build-and-push-docker.result }}
          - **Docker Security Scan:** ${{ needs.scan-docker-image.result }}
          - **Docker Test:** ${{ needs.test-docker-image.result }}
          - **Docker Notification:** ${{ needs.notify-docker-deployment.result }}

          ## Release Information
          - **Version:** ${{ needs.validate.outputs.version || 'N/A' }}
          - **Tag:** ${{ needs.validate.outputs.tag || 'N/A' }}
          - **Image Digest:** ${{ needs.build-and-push-docker.outputs.image-digest || 'No image pushed' }}

          ## Deployments
          - **PyPI:** https://pypi.org/project/souschef/${{ needs.validate.outputs.version || 'latest' }}/
          - **GitHub Release:** https://github.com/${{ github.repository }}/releases/tag/${{ needs.validate.outputs.tag || 'latest' }}
          - **Container Image:** ghcr.io/${{ github.repository_owner }}/mcp-souschef:${{ needs.validate.outputs.version || 'latest' }}

          ## Next Steps
          - Both PyPI package and Docker image are deployed
          - See GitHub Release for artifacts and release notes
          - See GitHub Security tab for Docker vulnerability scan results
          - Pull the Docker image: `docker pull ghcr.io/${{ github.repository_owner }}/mcp-souschef:${{ needs.validate.outputs.version || 'latest' }}`

          ## Workflow Run Details
          - **Workflow:** ${{ github.workflow }}
          - **Run ID:** ${{ github.run_id }}
          - **Run Number:** ${{ github.run_number }}
          EOF
          cat /tmp/summary.md >> $GITHUB_STEP_SUMMARY

      - name: Report failures
        if: |
          needs.validate.result != 'success'
          || needs.build.result != 'success'
          || needs.publish-pypi.result != 'success'
          || needs.create-release.result != 'success'
          || needs.build-and-push-docker.result != 'success'
          || needs.scan-docker-image.result != 'success'
          || needs.test-docker-image.result != 'success'
        run: |
          echo "### Release Pipeline Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Validation | ${{ needs.validate.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| PyPI Publish | ${{ needs.publish-pypi.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Create Release | ${{ needs.create-release.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker Build & Push | ${{ needs.build-and-push-docker.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker Scan | ${{ needs.scan-docker-image.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker Test | ${{ needs.test-docker-image.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please review the failed jobs above."
          exit 1
