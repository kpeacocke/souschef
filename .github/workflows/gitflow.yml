---
name: Gitflow Validation

# Only validate on PRs to avoid redundant runs
# Branch name validation happens when PR is opened/updated
"on":
  pull_request:
    types: [opened, reopened, synchronize, edited]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  validate-branch-name:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: read

    steps:
      - name: Check branch naming convention
        env:
          BRANCH_NAME: ${{ github.head_ref }}
        run: |

          echo "Validating branch: $BRANCH_NAME"

          # Allow main and develop
          if [[ "$BRANCH_NAME" == "main" ]] || \
             [[ "$BRANCH_NAME" == "develop" ]]; then
            echo "‚úì Protected branch: $BRANCH_NAME"
            exit 0
          fi

          # Validate gitflow branch naming
          if [[ "$BRANCH_NAME" =~ ^feature/.+ ]]; then
            echo "‚úì Valid feature branch: $BRANCH_NAME"
          elif [[ "$BRANCH_NAME" =~ ^release/.+ ]]; then
            echo "‚úì Valid release branch: $BRANCH_NAME"
          elif [[ "$BRANCH_NAME" =~ ^hotfix/.+ ]]; then
            echo "‚úì Valid hotfix branch: $BRANCH_NAME"
          elif [[ "$BRANCH_NAME" =~ ^bugfix/.+ ]]; then
            echo "‚úì Valid bugfix branch: $BRANCH_NAME"
          elif [[ "$BRANCH_NAME" =~ ^support/.+ ]]; then
            echo "‚úì Valid support branch: $BRANCH_NAME"
          else
            echo "‚úó Invalid branch name: $BRANCH_NAME"
            echo ""
            echo "Branch names must follow gitflow conventions:"
            echo "  - feature/<description>  (for new features)"
            echo "  - bugfix/<description>   (for bug fixes)"
            echo "  - release/<version>      (for release prep)"
            echo "  - hotfix/<version>       (for production fixes)"
            echo "  - support/<description>  (for support branches)"
            echo ""
            echo "Examples:"
            echo "  - feature/add-ansible-support"
            echo "  - bugfix/fix-parser-error"
            echo "  - release/1.2.0"
            echo "  - hotfix/1.1.1"
            exit 1
          fi

  validate-pr-base:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: github.event_name == 'pull_request'
    permissions:
      contents: read

    steps:
      - name: Validate PR target branch
        env:
          SOURCE_BRANCH: ${{ github.head_ref }}
          TARGET_BRANCH: ${{ github.base_ref }}
        run: |

          echo "PR: $SOURCE_BRANCH ‚Üí $TARGET_BRANCH"

          # Main should never merge to develop (wrong direction)
          if [[ "$SOURCE_BRANCH" == "main" ]]; then
            echo "‚úó Main branch cannot be used as source for PRs"
            echo "   Releases cut from main, not merged back"
            exit 1
          fi

          # Feature branches must target develop
          if [[ "$SOURCE_BRANCH" =~ ^feature/.+ ]]; then
            if [[ "$TARGET_BRANCH" != "develop" ]]; then
              echo "‚úó Feature branches must target 'develop',"
              echo "   not '$TARGET_BRANCH'"
              exit 1
            fi
            echo "‚úì Feature branch correctly targets develop"
          fi

          # Bugfix branches must target develop
          if [[ "$SOURCE_BRANCH" =~ ^bugfix/.+ ]]; then
            if [[ "$TARGET_BRANCH" != "develop" ]]; then
              echo "‚úó Bugfix branches must target 'develop',"
              echo "   not '$TARGET_BRANCH'"
              exit 1
            fi
            echo "‚úì Bugfix branch correctly targets develop"
          fi

          # Support branches can target develop or main
          if [[ "$SOURCE_BRANCH" =~ ^support/.+ ]]; then
            if [[ "$TARGET_BRANCH" != "develop" ]] && \
               [[ "$TARGET_BRANCH" != "main" ]]; then
              echo "‚úó Support must target 'develop' or 'main',"
              echo "   not '$TARGET_BRANCH'"
              exit 1
            fi
            echo "‚úì Support branch correctly targets $TARGET_BRANCH"
          fi

          # Release branches must target main
          if [[ "$SOURCE_BRANCH" =~ ^release/.+ ]]; then
            if [[ "$TARGET_BRANCH" != "main" ]]; then
              echo "‚úó Release branches must target 'main',"
              echo "   not '$TARGET_BRANCH'"
              exit 1
            fi
            echo "‚úì Release branch correctly targets main"
          fi

          # Hotfix branches must target main
          if [[ "$SOURCE_BRANCH" =~ ^hotfix/.+ ]]; then
            if [[ "$TARGET_BRANCH" != "main" ]]; then
              echo "‚úó Hotfix branches must target 'main',"
              echo "   not '$TARGET_BRANCH'"
              exit 1
            fi
            echo "‚úì Hotfix branch correctly targets main"
          fi

          # Develop can merge to main
          if [[ "$SOURCE_BRANCH" == "develop" ]]; then
            if [[ "$TARGET_BRANCH" != "main" ]]; then
              echo "‚úó Develop can only merge to 'main',"
              echo "   not '$TARGET_BRANCH'"
              exit 1
            fi
            echo "‚úì Develop correctly targets main"
          fi

  comment-pr-guidance:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: github.event_name == 'pull_request' && github.event.action == 'opened'
    permissions:
      pull-requests: write

    steps:
      - name: Comment gitflow guidance on new PRs
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const sourceBranch = pr.head.ref;
            const targetBranch = pr.base.ref;

            let branchType = 'unknown';
            if (sourceBranch.startsWith('feature/'))
              branchType = 'feature';
            else if (sourceBranch.startsWith('bugfix/'))
              branchType = 'bugfix';
            else if (sourceBranch.startsWith('release/'))
              branchType = 'release';
            else if (sourceBranch.startsWith('hotfix/'))
              branchType = 'hotfix';
            else if (sourceBranch === 'develop')
              branchType = 'develop';

            const guidance = {
              'feature': 'üåü **Feature**: Merge to `develop`, ' +
                         'then delete branch.',
              'bugfix': 'üêõ **Bugfix**: Merge to `develop`, ' +
                        'then delete branch.',
              'release': 'üöÄ **Release**: Merge to `main`, ' +
                         'merge back to `develop`, tag release.',
              'hotfix': 'üî• **Hotfix**: Merge to `main`, ' +
                        'merge back to `develop`, tag release.',
              'develop': 'üîÑ **Develop ‚Üí Main**: Release only. ' +
                         'Ensure all tests pass!'
            };

            if (guidance[branchType]) {
              const body = `## Gitflow Validation

            ${guidance[branchType]}

            ### Checklist:
            - [ ] All tests passing
            - [ ] Code reviewed
            - [ ] Documentation updated
            - [ ] Changelog updated (if applicable)

            ---
            _Automated gitflow guidance message._`;

              await github.rest.issues.createComment({
                issue_number: pr.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body
              });
            }
