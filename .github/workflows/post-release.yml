---
name: Sync Main to Develop

on:
  release:
    types: [published]
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync-develop:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout main with push token
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: main
          token: ${{ secrets.RELEASE_TOKEN }}

      - name: Configure Git identity
        run: |
          git config user.name "automation-bot"
          git config user.email "automation-bot@users.noreply.github.com"

      - name: Merge main into develop and push
        run: |
          set -e
          git fetch origin develop main
          git checkout develop
          git reset --hard origin/develop

          LATEST_COMMIT=$(git log -1 --pretty=format:"%h - %s" origin/main)
          MESSAGE="chore: sync main to develop - Latest: ${LATEST_COMMIT} - Triggered by: ${{ github.event_name }}"

          git merge --no-ff origin/main -m "$MESSAGE"

          # Ensure remote uses PAT for push
          git remote set-url origin https://x-access-token:${{ secrets.RELEASE_TOKEN }}@github.com/${{ github.repository }}

          git push origin develop

          echo "âœ“ Develop branch updated successfully via direct push"
