name: Sync Main to Develop

# This workflow runs after any push to main to keep develop in sync
# Includes releases, hotfixes, and dependency updates

on:
  push:
    branches: [main]
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: write
  pull-requests: write

jobs:
  sync-develop:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: Checkout main branch
      uses: actions/checkout@v6
      with:
        fetch-depth: 0  # Need full history for merging
        ref: main

    - name: Configure Git identity
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

    - name: Merge main into develop
      run: |
        # Checkout develop
        git checkout develop
        git pull origin develop

        # Get the latest commit info
        LATEST_COMMIT=$(git log -1 --pretty=format:"%h - %s" origin/main)
        echo "Latest commit: $LATEST_COMMIT"

        # Check if develop is already up to date with main
        if git merge-base --is-ancestor origin/main develop; then
          echo "‚úì Develop is already up to date with main"
          exit 0
        fi

        # Merge main into develop directly (since this is automated and trusted)
        echo "Merging main into develop..."
        if git checkout develop && git pull origin develop && git merge origin/main --no-ff -m "chore: sync main to develop

Automatic sync to keep develop up to date with main.

Latest commit: ${LATEST_COMMIT}
Triggered by: ${{ github.event_name }}"; then
          echo "‚úì Merge successful"
          git push origin develop
          echo "‚úì Develop branch updated successfully"
        else
          echo "‚úó Merge conflict detected"
          echo "Please resolve conflicts manually"
          git merge --abort
          exit 1
        fi

        # Merge main into the branch
        echo "Merging main into ${MERGE_BRANCH}..."
        if git merge origin/main --no-ff -m "chore: sync main to develop

        Automatic sync to keep develop up to date with main.

        Latest commit: ${LATEST_COMMIT}
        Triggered by: ${{ github.event_name }}"; then
          echo "‚úì Merge successful"

          # Push the branch
          git push -u origin "$MERGE_BRANCH"

          # Create PR using GitHub CLI (labels are optional)
          gh pr create \
            --base develop \
            --head "$MERGE_BRANCH" \
            --title "chore: sync main to develop" \
            --body "üîÑ Automatic sync from main to develop.

          **Latest commit:** ${LATEST_COMMIT}
          **Triggered by:** ${{ github.event_name }}

          This PR was automatically created to sync changes from main to develop.
          All changes merged successfully without conflicts." || true

          # Try to add labels (non-critical, continue on error)
          gh pr edit --add-label "automated" 2>/dev/null || echo "Note: Could not add 'automated' label (label may not exist)"
          gh pr edit --add-label "sync" 2>/dev/null || echo "Note: Could not add 'sync' label (label may not exist)"

          # Wait for checks to complete before enabling auto-merge
          PR_NUMBER=$(gh pr view "$MERGE_BRANCH" --json number -q .number)
          echo "Waiting for checks to pass on PR #$PR_NUMBER..."

          # Wait up to 10 minutes for checks to complete
          for i in {1..60}; do
            CHECKS_STATUS=$(gh pr checks "$PR_NUMBER" --json statusCheckRollup --jq 'all(.statusCheckRollup[]; .status == "COMPLETED")')
            if [ "$CHECKS_STATUS" = "true" ]; then
              echo "All checks passed, enabling auto-merge..."
              gh pr merge "$PR_NUMBER" --auto --squash
              echo "‚úì Auto-merge enabled for PR #$PR_NUMBER"
              break
            fi
            echo "Checks not complete yet, waiting... ($i/60)"
            sleep 10
          done

          if [ "$CHECKS_STATUS" != "true" ]; then
            echo "‚ö†Ô∏è Checks did not complete within timeout, PR #$PR_NUMBER created but auto-merge not enabled"
          fi
        else
          echo "‚úó Merge conflict detected"
          echo "Please resolve conflicts manually"
          git merge --abort
          exit 1
        fi
      env:
        GH_TOKEN: ${{ github.token }}
