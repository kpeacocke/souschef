---
name: Sync Main to Develop

# This workflow runs after any push to main to keep develop in sync
# Includes releases, hotfixes, and dependency updates

on:
  push:
    branches: [main]
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: write
  pull-requests: write

jobs:
  sync-develop:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: Checkout main branch
      uses: actions/checkout@v6
      with:
        fetch-depth: 0  # Need full history for merging
        ref: main

    - name: Configure Git identity
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

    - name: Merge main into develop
      run: |
        # Checkout develop
        git checkout develop
        git pull origin develop

        # Get the latest commit info
        LATEST_COMMIT=$(git log -1 --pretty=format:"%h - %s" origin/main)
        echo "Latest commit: $LATEST_COMMIT"

        # Define commit message
        MESSAGE="chore: sync main to develop\n\nLatest: ${LATEST_COMMIT}"

        # Check if develop is already up to date with main
        if git merge-base --is-ancestor origin/main develop; then
          echo "✓ Develop is already up to date with main"
          exit 0
        fi

        # Merge main into develop to preserve history (safer for shared branches)
        echo "Merging main into develop..."
        if git checkout develop && git pull origin develop; then
          MESSAGE="chore: sync main to develop\n\nAutomatic sync to keep develop up to date with main.\n\nLatest commit: ${LATEST_COMMIT}\nTriggered by: ${{ github.event_name }}"
          if git merge origin/main --no-ff -m "$MESSAGE"; then
            git push origin develop
            echo "✓ Develop branch updated with merge commit"
          else
            echo "✗ Merge failed, attempting rebase as last resort"
            git merge --abort || true
            if git rebase origin/main; then
              echo "✓ Rebase successful as fallback"
              git push origin develop --force-with-lease
              echo "✓ Develop branch updated successfully"
            else
              echo "✗ Both merge and rebase failed"
              git rebase --abort || true
              exit 1
            fi
          fi
        else
          echo "✗ Failed to checkout/pull develop branch"
          exit 1
        fi
